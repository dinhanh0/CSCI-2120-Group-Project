import java.io.*;
import java.util.*;

public class AddItems {

    private static final String ITEM_FILE = "grocery_items.csv"; // Path to items.csv
    private static final String CART_FILE = "cart.csv";  // Path to cart.csv

    public static void addItem(Scanner scanner, double budget, String store) {
        List<String[]> items = readCsv(ITEM_FILE);

        if (items.isEmpty()) {
            System.out.println("No items available to add.");
            return;
        }

        // Extract unique categories
        List<String> categories = new ArrayList<>();
        for (String[] item : items) {
            String category = item[1];
            if (!categories.contains(category)) {
                categories.add(category);
            }
        }

        // Display categories
        System.out.println("Available Categories:");
        for (int i = 0; i < categories.size(); i++) {
            System.out.println((i + 1) + ". " + categories.get(i));
        }

        System.out.print("Select a category (enter number): ");
        int categoryChoice = scanner.nextInt();
        scanner.nextLine(); // Consume newline

        if (categoryChoice < 1 || categoryChoice > categories.size()) {
            System.out.println("Invalid category selection.");
            return;
        }

        String selectedCategory = categories.get(categoryChoice - 1);

        // Filter items in the selected category
        List<String[]> selectedItems = new ArrayList<>();
        for (String[] item : items) {
            if (item[1].equals(selectedCategory)) {
                selectedItems.add(item);
            }
        }

        // Display items in the selected category
        System.out.println("Items in " + selectedCategory + ":");
        for (int i = 0; i < selectedItems.size(); i++) {
            System.out.println((i + 1) + ". " + selectedItems.get(i)[0] + " ($" + selectedItems.get(i)[2] + ")");
        }

        System.out.print("Select an item to add to cart (enter number): ");
        int itemChoice = scanner.nextInt();
        scanner.nextLine(); // Consume newline

        if (itemChoice < 1 || itemChoice > selectedItems.size()) {
            System.out.println("Invalid item selection.");
            return;
        }

        String[] selectedItem = selectedItems.get(itemChoice - 1);

        // Add item to cart
        try (FileWriter fw = new FileWriter(CART_FILE, true);
             BufferedWriter bw = new BufferedWriter(fw);
             PrintWriter pw = new PrintWriter(bw)) {

            pw.println(String.join(",", selectedItem));
            System.out.println("Item added to cart: " + selectedItem[0]);
        } catch (IOException e) {
            System.err.println("Error writing to cart file: " + e.getMessage());
        }
    }

    public static double viewCart(Scanner scanner, double budget) {
        List<String[]> cart = readCsv(CART_FILE);
        if (cart.isEmpty()) {
            System.out.println("Your cart is empty.");
            return budget;
        }

        double totalPrice = 0;
        System.out.println("Items in your cart:");
        for (String[] item : cart) {
            String itemName = item[0];
            double price = Double.parseDouble(item[2]);
            totalPrice += price;
            System.out.println(itemName + " - $" + price);
        }

        System.out.println("Total price: $" + totalPrice);
        System.out.print("Are you ready to check out? (yes/no): ");
        String checkoutChoice = scanner.next();

        if ("yes".equalsIgnoreCase(checkoutChoice)) {
            if (budget >= totalPrice) {
                double remainingBudget = budget - totalPrice;
                System.out.println("You successfully bought the items. Remaining budget: $" + remainingBudget);
                System.out.print("Would you like to continue shopping? (yes/no): ");
                if ("yes".equalsIgnoreCase(scanner.next())) {
                    System.out.print("Enter your new budget: ");
                    return scanner.nextDouble();
                } else {
                    System.out.println("Thank you for shopping!");
                    System.exit(0);
                }
            } else {
                System.out.println("You can't afford the items. Would you like to remove some items? (yes/no): ");
                if ("yes".equalsIgnoreCase(scanner.next())) {
                    deleteItem(scanner);
                } else {
                    System.out.println("Continuing with current cart.");
                }
            }
        }
        return budget;
    }

    private static void deleteItem(Scanner scanner) {
        List<String[]> cart = readCsv(CART_FILE);
        if (cart.isEmpty()) {
            System.out.println("Your cart is empty.");
            return;
        }

        System.out.println("Items in your cart:");
        for (int i = 0; i < cart.size(); i++) {
            System.out.println((i + 1) + ". " + cart.get(i)[0] + " ($" + cart.get(i)[2] + ")");
        }

        System.out.print("Select an item to remove (enter number): ");
        int itemChoice = scanner.nextInt();
        scanner.nextLine(); // Consume newline

        if (itemChoice > 0 && itemChoice <= cart.size()) {
            cart.remove(itemChoice - 1);
            try (PrintWriter pw = new PrintWriter(new FileWriter(CART_FILE))) {
                for (String[] item : cart) {
                    pw.println(String.join(",", item));
                }
                System.out.println("Item removed successfully.");
            } catch (IOException e) {
                System.err.println("Error updating cart file: " + e.getMessage());
            }
        } else {
            System.out.println("Invalid choice.");
        }
    }

    private static List<String[]> readCsv(String fileName) {
        List<String[]> data = new ArrayList<>();
        try (BufferedReader br = new BufferedReader(new FileReader(fileName))) {
            br.readLine(); // Skip header
            String line;
            while ((line = br.readLine()) != null) {
                data.add(line.split(","));
            }
        } catch (IOException e) {
            System.err.println("Error reading file: " + e.getMessage());
        }
        return data;
    }
}
